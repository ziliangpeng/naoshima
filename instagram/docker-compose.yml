version: '3'

# TODO: compose supports 'extends', so we can abstract common bot logic into gneral-bot service
# TODO: compose supports `-f` to load different config files. Can implement some one-off jobs in another file
# TODO: maybe can use environment variable (either Dockerfile level or compose level) to customize one bot service
services:
  ardb:
    # docker-compose up -d ardb
    image: lupino/ardb-server
    container_name: ardb-server
    ports:
      - "6379:16379"
    volumes:
      - /data/ig-ardb:/var/lib/ardb
  ardb-cache:
    image: lupino/ardb-server
    container_name: ardb-server-cache
    volumes:
      - /data/ig-ardb-cache:/var/lib/ardb
  bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    # links is deprecated. we want to migrate to docker's user defined network.
    # we may also provision ardb inside here (bot own its data storage)
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  z-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "z"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  airbnb-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "airbnb"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  v-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "v"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  mc-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "mc"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  hix-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "hix"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  newdone-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "newdone"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  let-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "let"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  eva-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "eva"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  eaxy-bot:
    build: .
    volumes:
      - /data/ig:/data/ig
    entrypoint:
      - "python"
      - "bot.py"
      - "-u"
      - "eaxy"
    links:
     - ardb:redis
     - ardb-cache:redis-cache
  likes:
    build: ./goscripts
    entrypoint:
      - "go"
      - "run"
      - "main.go"
      - "-t"
      - "likes"
      - "-u"
  follow:
    build: ./goscripts
    entrypoint:
      - "./main"
      - "-t"
      - "follow"
      - "-u"

#We need a way to achieve the following:
#- one click to bring up all of the several accounts on prod
#- one click to bring up another account on dev
#
#Existing tools:
#- runit service
#  - auto start after reboot
#  - can monitor status of each
#  - make sure always up, and exactly one instance
#- docker-compose run
#  - parameterizable of service definition
#  - need to manually run (cannot survive reboot)
#  - will have N instance if run N times
#- docker-compose up
#  - not parameteriable
#  - exactly one instance
#  - need manually run (cannot survive reboot)
#
#Solution:
#- runit + compose run
#  - one docker-compose service, several runit service
#- docker-compose up
#  - need to run individually for each account, unless prod and dev have different difinition file
